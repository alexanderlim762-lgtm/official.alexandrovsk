<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Профиль</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Верхнее меню -->
<div class="vhs-menu">
    <ul>
        <li><a href="index.html">Главная</a></li>
        <li><a href="news.html">Новости</a></li>
        <li><a href="rules.html">Правила</a></li>
        <li><a href="updates.html">Обновления</a></li>
        <li><a href="plays.html">Проекты</a></li>
    </ul>
    <div>
        <img id="menu-avatar" class="menu-avatar" src="" alt="" onclick="goToProfile()">
        <span id="menu-login" class="menu-login" onclick="goToLogin()">Войти</span>
    </div>
</div>

<main>
<div class="profile-container">
    <div class="profile-header">
        <img id="profile-avatar" class="profile-avatar" src="default-avatar.png" alt="Аватар">
        <div>
            <button class="vhs-button" onclick="logout()">Выйти из аккаунта</button>
        </div>
    </div>

    <div class="profile-info">
        <label>Никнейм:</label>
        <input type="text" id="nickname" readonly>

        <label>О себе:</label>
        <textarea id="about" placeholder="Расскажите о себе"></textarea>

        <label>Ссылки:</label>
        <input type="text" id="youtube" placeholder="YouTube">
        <input type="text" id="telegram" placeholder="Telegram">
        <input type="text" id="discord" placeholder="Discord">

        <label>Загрузить аватар:</label>
        <input type="file" id="avatar-input" accept="image/*">
    </div>

    <h2>Поиск пользователей</h2>
<input type="text" id="search-input" placeholder="Введите никнейм">
<ul id="search-results"></ul>

</div>
</main>
<script>
const searchInput = document.getElementById('search-input');
const searchResultsEl = document.getElementById('search-results');

// Симуляция "базы всех пользователей" через localStorage
let allUsers = JSON.parse(localStorage.getItem('allUsers')) || [];

// Поиск по никнейму
searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    searchResultsEl.innerHTML = '';
    if(query.length === 0) return;

    const results = allUsers.filter(u => u.nickname.toLowerCase().includes(query) && u.nickname !== currentUser.nickname);
    results.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user.nickname;

        const addBtn = document.createElement('button');
        addBtn.textContent = "Добавить в друзья";
        addBtn.classList.add('vhs-button');
        addBtn.style.marginLeft = '10px';

        addBtn.addEventListener('click', () => {
            sendFriendRequest(user.nickname);
        });

        li.appendChild(addBtn);
        searchResultsEl.appendChild(li);
    });
});

// ================== Заявка в друзья ==================
function sendFriendRequest(friendNickname){
    // Найти пользователя в allUsers
    let friend = allUsers.find(u => u.nickname === friendNickname);
    if(!friend.requests) friend.requests = [];

    // Проверка, что заявка ещё не отправлена
    if(friend.requests.includes(currentUser.nickname)){
        alert("Вы уже отправили заявку этому пользователю");
        return;
    }

    friend.requests.push(currentUser.nickname);
    localStorage.setItem('allUsers', JSON.stringify(allUsers));
    alert("Заявка отправлена!");
}

// ================== Обработка входящих заявок ==================
function renderFriendRequests(){
    if(!currentUser.requests) currentUser.requests = [];
    currentUser.requests.forEach(req => {
        const li = document.createElement('li');
        li.textContent = req;

        const acceptBtn = document.createElement('button');
        acceptBtn.textContent = "Принять";
        acceptBtn.classList.add('vhs-button');
        acceptBtn.style.marginLeft = '5px';

        acceptBtn.addEventListener('click', () => {
            if(!currentUser.friends) currentUser.friends = [];
            currentUser.friends.push(req);

            // Добавляем текущего пользователя в друзья отправителю
            let sender = allUsers.find(u => u.nickname === req);
            if(!sender.friends) sender.friends = [];
            sender.friends.push(currentUser.nickname);

            // Удаляем заявку
            currentUser.requests = currentUser.requests.filter(r => r !== req);
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('allUsers', JSON.stringify(allUsers));
            renderFriendRequests();
            renderFriends();
        });

        const rejectBtn = document.createElement('button');
        rejectBtn.textContent = "Отклонить";
        rejectBtn.classList.add('vhs-button');
        rejectBtn.style.marginLeft = '5px';

        rejectBtn.addEventListener('click', () => {
            currentUser.requests = currentUser.requests.filter(r => r !== req);
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            renderFriendRequests();
        });

        li.appendChild(acceptBtn);
        li.appendChild(rejectBtn);
        searchResultsEl.appendChild(li);
    });
}

// Рендер друзей и заявок при загрузке
renderFriends();
renderFriendRequests();

</script>
</body>
</html>
